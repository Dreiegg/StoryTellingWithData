<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <title>Electrical vehicle registration by US-state</title>
    <style>
        .label {
            margin-left: 15px;
        }

        #selection {
            font-size: 19px;
            margin-left: 15px;
        }

        .tooltip {
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            position: absolute;
            z-index: 10;
        }
    </style>
</head>

<body>
    <h1 style="text-align: center">Electrical vehicle registration by US-state</h1>
    <p style="text-align: center">Toggle between absolute and relative data</p>
    <p style="text-align: center">Authors: Antonia Pecha, Simon Schnetzer, Leo Schweiger, Luca Troger</p>
    <div id="selectMe"></div>
    <div id="chartContainer"></div>

    <script>
        const w = 1000;
        const h = 500;
        const margins = { top: 50, left: 100, bottom: 100, right: 100 }
        const innerWidth = w - margins.left - margins.right;
        const innerHeight = h - margins.top - margins.bottom;
        const url = "data/better data new(2).csv";

        let yScaleType = "electric";

        d3.csv(url).then(data => {
            data.forEach(d => {
                d.state = d.state;
                d.electric = +d.electric;
                d.rel_electric = +d.rel_electric;
            });

            const mySelection = document.getElementById("selectMe");

            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background", "#fff")
                .style("border", "1px solid #ccc")
                .style("padding", "5px 10px")
                .style("border-radius", "4px")
                .style("pointer-events", "none")
                .style("opacity", 0);

            const selectItems = ["Alphabetic", "Descending", "Numbers relative to population"];

            d3.select(mySelection)
                .append("span")
                .append("select")
                .attr("id", "selection")
                .attr("name", "tasks")
                .selectAll("option")
                .data(selectItems)
                .enter()
                .append("option")
                .text(d => d);

            myChart();

            d3.select("#selection").on("change", function () {
                const selectedOption = d3.select(this).node().value;
                if (selectedOption == "Descending") {
                    data.sort((a, b) => d3.descending(a.electric, b.electric));
                    yScaleType = "electric";
                } else if (selectedOption == "Alphabetic") {
                    data.sort((a, b) => {
                        if (a.state === "United States") return 1;
                        if (b.state === "United States") return -1;
                        return d3.ascending(a.state, b.state);
                    });
                    yScaleType = "electric";
                } else if (selectedOption == "Numbers relative to population") {
                    data.sort((a, b) => d3.descending(a.rel_electric, b.rel_electric));
                    yScaleType = "rel_electric";
                }
                myChart();
            });

            function myChart() {
                const chartDIV = document.createElement("div");

                const xScale = d3.scaleBand()
                    .domain(data.map((d) => d.state))
                    .rangeRound([0, innerWidth])
                    .paddingInner(0.05);

                const yMax = d3.max(data, (d) => d[yScaleType]);
                const yScale = d3.scaleLinear()
                    .domain([0, yMax]).nice()
                    .range([innerHeight, 0]);

                const xAxis = d3.axisBottom().scale(xScale);
                const yAxis = d3.axisLeft().scale(yScale).tickFormat(d => d3.format(".1f")(d / 1_000_000) + " Mill");

                const svg = d3.select(chartDIV)
                    .append("svg")
                    .attr("viewBox", [0, 0, w, h]);

                const mainG = svg
                    .append("g")
                    .attr("transform", `translate(${margins.left}, ${margins.top})`);

                const g = mainG
                    .selectAll("g")
                    .data(data)
                    .enter()
                    .append("g")
                    .attr("transform", `translate(0,0)`);

                g.append("rect")
                    .attr("class", "bars")
                    .attr("x", d => xScale(d.state))
                    .attr("y", d => yScale(d[yScaleType]))
                    .attr("width", xScale.bandwidth())
                    .attr("height", d => innerHeight - yScale(d[yScaleType]))
                    .attr("fill", d => d[yScaleType] == yMax ? "#7932FA" : "green")
                    .on("mouseover", function (event, d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0.9);
                        tooltip.html(d[yScaleType])
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        d3.select(this).attr("fill", "#ff8800");
                    })
                    .on("mousemove", function (event) {
                        tooltip.style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (event, d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                        d3.select(this).attr("fill", d => d[yScaleType] == yMax ? "#f4c430" : "green");
                    });

                g.append("text")
                    .attr("class", "bar-label")
                    .attr("x", d => xScale(d.state) + xScale.bandwidth() / 2)
                    .attr("y", d => yScale(d[yScaleType]) - 5)
                    .attr("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("fill", "#333")
                    .style("opacity", 0)
                    .text(d => d3.format(".1f")(d[yScaleType] / 1000) + "K");

                g.selectAll("rect")
                    .on("mouseover", function (event, d, i) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0.9);
                        tooltip.html(d[yScaleType])
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");

                        d3.select(this).attr("fill", "#ff8800");

                        d3.select(this.parentNode).select("text")
                            .transition().duration(100)
                            .style("opacity", 1);
                    })
                    .on("mousemove", function (event) {
                        tooltip.style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (event, d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                        d3.select(this).attr("fill", d => d[yScaleType] == d3.max(data, d => d[yScaleType]) ? "#f4c430" : "green");

                        d3.select(this.parentNode).select("text")
                            .transition().duration(100)
                            .style("opacity", 0);
                    });

                mainG
                    .append("g")
                    .call(xAxis)
                    .attr("transform", `translate(0, ${innerHeight})`)
                    .selectAll("text")
                    .attr("transform", "rotate(-45)")
                    .style("text-anchor", "end");

                mainG
                    .append("g")
                    .call(yAxis);

                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("transform", `translate(${margins.left / 2}, ${margins.top + innerHeight / 2}) rotate(-90)`)
                    .style("font-size", "16px")
                    .style("fill", "#333")
                    .text(yScaleType === "electric" ? "Number of Electric Vehicles" : "EVs per total registered vehicles");

                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", margins.left + innerWidth / 2)
                    .attr("y", h - 10)
                    .style("font-size", "16px")
                    .style("fill", "#333")
                    .text("US States");

                const showChart = document.getElementById("chartContainer");
                while (showChart.firstChild) {
                    showChart.firstChild.remove();
                }
                showChart.appendChild(chartDIV);
            }
        }).catch(error => {
            console.error("Error loading the CSV data:", error);
        });
    </script>
</body>

</html>