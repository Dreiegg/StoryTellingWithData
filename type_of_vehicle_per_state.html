<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Types in California</title>
    <style>
        body {
            font-family: 'Nunito', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tooltip {
            position: absolute;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 15px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 8px;
            border-radius: 3px;
        }
        
        text {
            font-family: 'Nunito', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vehicle Types Distribution in California</h1>
        <div class="chart-container">
            <div id="pie-chart"></div>
            <div class="legend" id="legend"></div>
        </div>
    </div>

    <!-- Load D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <script>
        // Set dimensions and margins for the chart
        const width = 500;
        const height = 500;
        const margin = 40;
        
        // The radius of the pie chart is half the smallest side
        const radius = Math.min(width, height) / 2 - margin;
        
        // Create SVG
        const svg = d3.select('#pie-chart')
            .append('svg')
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', `translate(${width / 2}, ${height / 2})`);
        
        // Create tooltip div
        const tooltip = d3.select('body')
            .append('div')
            .attr('class', 'tooltip');
        
        // Define color scheme
        const colorScale = d3.scaleOrdinal()
            .domain(['electric', 'hybrid', 'alternativeFuels', 'combustion', 'unknown'])
            .range(['#4CAF50', '#8BC34A', '#2196F3', '#607D8B', '#9E9E9E']);
        
        // Nice display names for categories
        const categoryNames = {
            'electric': 'Electric',
            'hybrid': 'Hybrid',
            'alternativeFuels': 'Alternative Fuels',
            'combustion': 'Combustion',
            'unknown': 'Unknown'
        };
        
        // Load the data
        d3.csv('data/better data new(2).csv').then(function(data) {
            // Filter for California
            const californiaData = data.find(d => d.state === 'California');
            
            // Format the data for the pie chart
            const pieData = [
                { type: 'electric', value: +californiaData.electric },
                { type: 'hybrid', value: +californiaData.hybrid },
                { type: 'alternativeFuels', value: +californiaData.alternativeFuels },
                { type: 'combustion', value: +californiaData.combustion },
                { type: 'unknown', value: +californiaData.unknown }
            ];
            
            // Format numbers with commas
            const formatNumber = d3.format(',');
            
            // Format percentages
            const formatPercent = d3.format('.2%');
            
            // Compute the percentage for each category
            const total = d3.sum(pieData, d => d.value);
            pieData.forEach(d => {
                d.percentage = d.value / total;
            });
            
            // Create pie generator
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null); // Don't sort, keep the order from the data
            
            // Generate the arcs
            const arcGenerator = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);
            
            // Create arc for hover effect
            const arcHover = d3.arc()
                .innerRadius(0)
                .outerRadius(radius * 1.1);
            
            // Join the data with pie generator
            const arcs = svg.selectAll('arc')
                .data(pie(pieData))
                .enter()
                .append('g')
                .attr('class', 'arc');
            
            // Draw the paths (pie slices)
            arcs.append('path')
                .attr('d', arcGenerator)
                .attr('fill', d => colorScale(d.data.type))
                .attr('stroke', 'white')
                .style('stroke-width', '2px')
                .style('opacity', 0.8)
                .on('mouseover', function(event, d) {
                    // Enlarge the slice
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arcHover)
                        .style('opacity', 1);
                    
                    // Show tooltip
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', 0.9);
                    
                    tooltip.html(`
                        <strong>${categoryNames[d.data.type]}</strong><br>
                        Count: ${formatNumber(d.data.value)}<br>
                        Percentage: ${formatPercent(d.data.percentage)}
                    `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    // Return to normal size
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('d', arcGenerator)
                        .style('opacity', 0.8);
                    
                    // Hide tooltip
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);
                });
            
            // Add labels for large enough slices
            arcs.filter(d => d.endAngle - d.startAngle > 0.1)
                .append('text')
                .attr('transform', d => {
                    const pos = arcGenerator.centroid(d);
                    // Move text slightly outward for better readability
                    const x = pos[0] * 1.1;
                    const y = pos[1] * 1.1;
                    return `translate(${x}, ${y})`;
                })
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', 'white')
                .style('pointer-events', 'none')
                .text(d => d.data.percentage > 0.03 ? formatPercent(d.data.percentage) : '');
            
            // Add a legend
            const legend = d3.select('#legend');
            
            const legendItems = legend.selectAll('.legend-item')
                .data(pieData)
                .enter()
                .append('div')
                .attr('class', 'legend-item');
            
            legendItems.append('div')
                .attr('class', 'legend-color')
                .style('background-color', d => colorScale(d.type));
            
            legendItems.append('div')
                .text(d => `${categoryNames[d.type]}: ${formatNumber(d.value)} (${formatPercent(d.percentage)})`);
        });
    </script>
</body>
</html>